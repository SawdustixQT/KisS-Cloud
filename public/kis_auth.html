<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 400px; margin: auto; }
        input { display: block; width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; }
        #messageArea { margin-top: 15px; padding: 10px; border: 1px solid #ccc; min-height: 20px; }
        /* Добавил стиль, чтобы ссылки выглядели как кликабельный текст */
        .auth-link { cursor: pointer; color: blue; text-decoration: underline; }
    </style>
</head>
<body>
<div class="container">
    <h1>Авторизация</h1>

    <div id="authSection">
        <h2>Вход</h2>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="Имя пользователя" required>
            <input type="password" id="loginPassword" placeholder="Пароль" required>
            <button type="submit">Войти</button>
        </form>
        <!-- Добавлена ссылка с onclick="continueWithoutAuth()" -->
        <p> <a class="auth-link" onclick="continueWithoutAuth()">Продолжить без авторизации</a></p>
        <p>Нет аккаунта? <a href="#" onclick="showRegister()">Зарегистрироваться</a></p>
    </div>

    <div id="registerSection" style="display: none;">
        <h2>Регистрация</h2>
        <form id="registerForm">
            <input type="text" id="registerUsername" placeholder="Имя пользователя" required>
            <input type="password" id="registerPassword" placeholder="Пароль" required>
            <button type="submit">Зарегистрироваться</button>
        </form>
        <!-- Добавлена ссылка с onclick="continueWithoutAuth()" -->
        <p> <a class="auth-link" onclick="continueWithoutAuth()">Продолжить без авторизации</a></p>
        <p>Уже есть аккаунт? <a href="#" onclick="showLogin()">Войти</a></p>
    </div>

    <div id="profileSection" style="display: none;">
        <h2>Профиль пользователя</h2>
        <p id="welcomeMessage"></p>
        <button onclick="fetchProfileData()">Запросить данные профиля (защищенный маршрут)</button>
        <button onclick="logout()">Выйти</button>
    </div>

    <div id="messageArea"></div>
</div>

<script>
    // URL для редиректа на страницу профиля.
    // Обратите внимание: этой страницы (profile.html) пока нет в вашем коде,
    // редирект на неё произойдёт, но браузер покажет ошибку 404, пока вы её не создадите.
    const REDIRECT_URL = 'profile.html';

    const messageArea = document.getElementById('messageArea');
    const authSection = document.getElementById('authSection');
    const registerSection = document.getElementById('registerSection');
    const profileSection = document.getElementById('profileSection');
    const welcomeMessage = document.getElementById('welcomeMessage');

    // Переменная для отслеживания условного "количества пользователей"
    // (в реальном приложении это число должно приходить с сервера)
    let userCountPlaceholder = 5;

    function logMessage(message, isError = false) {
        messageArea.textContent = message;
        messageArea.style.color = isError ? 'red' : 'green';
    }

    function showLogin() {
        authSection.style.display = 'block';
        registerSection.style.display = 'none';
    }

    function showRegister() {
        authSection.style.display = 'none';
        registerSection.style.display = 'block';
    }

    function showProfile() {
        authSection.style.display = 'none';
        registerSection.style.display = 'none';
        profileSection.style.display = 'block';
    }

    // --- НОВАЯ ФУНКЦИЯ ---
    function continueWithoutAuth() {
        // Генерируем случайное число i от 1 до userCountPlaceholder
        const userId = Math.floor(Math.random() * userCountPlaceholder) + 1;
        const username = `user_${userId}`;

        // В данном примере мы просто сохраняем имя в localStorage (без токена)
        // и выполняем редирект.
        // В реальном приложении сервер может выдать временный токен "гостя".
        localStorage.setItem('guestUsername', username);

        // Выводим сообщение в консоль и делаем редирект
        console.log(`Продолжаем как гость: ${username}. Редирект на ${REDIRECT_URL}`);
        window.location.href = REDIRECT_URL;
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            logMessage('Регистрация успешна! Теперь войдите в систему.');
            // Увеличиваем счетчик пользователей при успешной регистрации (условный пример)
            userCountPlaceholder++;
            showLogin();
        } else {
            const error = await response.text();
            logMessage(error, true);
            alert('Ошибка')
        }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });


        const data = await response.json();


        if (response.ok) {
            logMessage(data.message);
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('user', username);
            localStorage.setItem('role', data.role);
            // welcomeMessage.textContent = `Вы вошли как ${username}.`; // Эта строка не нужна, так как сразу происходит редирект
            window.location.href = REDIRECT_URL;
        } else {
            logMessage(data, true);
            alert('Неверный логин или пароль')
        }
    });



    // --- Получение данных профиля с защищенного маршрута ---
    async function fetchProfileData() {
        const token = localStorage.getItem('authToken');

        const response = await fetch('/api/profile', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}` // Отправляем токен в заголовке
            }
        });

        const data = await response.json();

        if (response.ok) {
            logMessage(data.message);
        } else {
            logMessage(`Ошибка доступа к профилю: ${data.message || response.statusText}`, true);
            if (response.status === 403 || response.status === 401) {
                logout(); // Если токен просрочен/невалиден, выходим из системы
            }
        }
    }

    // --- Выход из системы ---
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('guestUsername'); // Очищаем данные гостя при выходе
        logMessage('Вы вышли из аккаунта.');
        showLogin();
    }

    // При загрузке страницы проверяем, есть ли уже токен или имя гостя
    if (localStorage.getItem('authToken') || localStorage.getItem('guestUsername')) {
        // В реальном приложении при загрузке этой страницы мы должны
        // сразу проверить наличие токена/гостя и перенаправить на REDIRECT_URL,
        // а не показывать текущий экран логина/профиля,
        // но в рамках предоставленного HTML-кода я оставляю базовую логику.
        // showProfile();
        // Для демонстрации работы редиректа при загрузке:
        // window.location.href = REDIRECT_URL;
    } else {
        showLogin();
    }

</script>
</body>
</html>
