<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 400px; margin: auto; }
        input { display: block; width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; }
        #messageArea { margin-top: 15px; padding: 10px; border: 1px solid #ccc; min-height: 20px; }
        .auth-link { cursor: pointer; color: blue; text-decoration: underline; }
    </style>
</head>
<body>
<div class="container">
    <h1>Авторизация</h1>

    <div id="authSection">
        <h2>Вход</h2>
        <form id="loginForm">
            <input type="text" id="loginUsername" name="username" placeholder="Имя пользователя" required>
            <input type="password" id="loginPassword" name="password" placeholder="Пароль" required>
            <button type="submit">Войти</button>
        </form>
        <p> <a class="auth-link" onclick="continueWithoutAuth()">Продолжить без авторизации</a></p>
        <p>Нет аккаунта? <a href="#" onclick="showRegister()">Зарегистрироваться</a></p>
    </div>

    <div id="registerSection" style="display: none;">
        <h2>Регистрация</h2>
        <form id="registerForm">
            <input type="text" id="registerUsername" placeholder="Имя пользователя" required>
            <input type="password" id="registerPassword" placeholder="Пароль" required>
            <button type="submit">Зарегистрироваться</button>
        </form>
        <p> <a class="auth-link" onclick="continueWithoutAuth()">Продолжить без авторизации</a></p>
        <p>Уже есть аккаунт? <a href="#" onclick="showLogin()">Войти</a></p>
    </div>

    <div id="profileSection" style="display: none;">
        <h2>Профиль пользователя</h2>
        <p id="welcomeMessage"></p>
        <button onclick="fetchProfileData()">Запросить данные профиля (защищенный маршрут)</button>
        <button onclick="logout()">Выйти</button>
    </div>

    <div id="messageArea"></div>
</div>

<script>
    const REDIRECT_URL = 'profile.html';
    const messageArea = document.getElementById('messageArea');
    const authSection = document.getElementById('authSection');
    const registerSection = document.getElementById('registerSection');
    const profileSection = document.getElementById('profileSection');
    const welcomeMessage = document.getElementById('welcomeMessage');

    function logMessage(message, isError = false) {
        messageArea.textContent = message;
        messageArea.style.color = isError ? 'red' : 'green';
    }

    function showLogin() {
        authSection.style.display = 'block';
        registerSection.style.display = 'none';
    }

    function showRegister() {
        authSection.style.display = 'none';
        registerSection.style.display = 'block';
    }

    function showProfile() {
        authSection.style.display = 'none';
        registerSection.style.display = 'none';
        profileSection.style.display = 'block';
    }

    // ✅ ИСПРАВЛЕНА: Авторизация с guest/guest при нажатии "Продолжить без авторизации"
    async function continueWithoutAuth() {
        const username = 'guest';
        const password = 'guest';

        try {
            logMessage('Авторизация как гость...');

            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const responseText = await response.text();
            let data;

            try {
                data = JSON.parse(responseText);
            } catch {
                if (response.ok) {
                    data = { message: 'Гостевой вход успешен', token: 'guest_token', role: 'guest' };
                } else {
                    throw new Error(responseText || 'Ошибка сервера');
                }
            }

            if (response.ok || data.role === 'guest') {
                // ✅ Сохраняем данные гостевой сессии
                localStorage.setItem('authToken', data.token || 'guest_token');
                localStorage.setItem('user', username);
                localStorage.setItem('role', 'guest');
                localStorage.setItem('isGuest', 'true');

                logMessage(`Добро пожаловать, ${username}! Переход к профилю...`);

                // Небольшая задержка для показа сообщения
                setTimeout(() => {
                    window.location.href = REDIRECT_URL;
                }, 1000);
            } else {
                logMessage(data.message || 'Ошибка гостевого входа', true);
            }
        } catch (error) {
            console.error('Ошибка гостевого входа:', error);

            // ✅ Fallback: создание локальной гостевой сессии
            localStorage.setItem('authToken', `guest_${Date.now()}`);
            localStorage.setItem('user', 'guest');
            localStorage.setItem('role', 'guest');
            localStorage.setItem('isGuest', 'true');

            logMessage('Создана локальная гостевая сессия');
            setTimeout(() => {
                window.location.href = REDIRECT_URL;
            }, 1000);
        }
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                logMessage('Регистрация успешна! Теперь войдите в систему.');
                showLogin();
            } else {
                const error = await response.text();
                logMessage(error, true);
            }
        } catch (error) {
            logMessage('Ошибка регистрации', true);
        }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                logMessage(data.message);
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('user', username);
                localStorage.setItem('role', data.role);
                window.location.href = REDIRECT_URL;
            } else {
                logMessage(data.message || 'Неверный логин или пароль', true);
            }
        } catch (error) {
            logMessage('Ошибка входа', true);
        }
    });

    async function fetchProfileData() {
        const token = localStorage.getItem('authToken');
        try {
            const response = await fetch('/api/profile', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (response.ok) {
                logMessage(data.message);
            } else {
                logMessage(`Ошибка: ${data.message || response.statusText}`, true);
                if (response.status === 401 || response.status === 403) {
                    logout();
                }
            }
        } catch (error) {
            logMessage('Ошибка запроса профиля', true);
        }
    }

    function logout() {
        localStorage.clear();
        logMessage('Вы вышли из аккаунта');
        showLogin();
    }

    // Инициализация
    if (localStorage.getItem('authToken')) {
        window.location.href = REDIRECT_URL;
    } else {
        showLogin();
    }
</script>
</body>
</html>
