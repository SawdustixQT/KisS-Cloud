<style>
:root{
  --p1:#05386B;
  --p2:#379683;
  --p3:#5CDB95;
  --p4:#8EE4AF;
  --p5:#EDF5E1;

  --border: rgba(237,245,225,.22);
  --text-muted: rgba(237,245,225,.7);
  --shadow: 0 18px 50px rgba(0,0,0,.35);
  --radius: 18px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

.support-chat *{box-sizing:border-box;font-family:var(--font);}

.support-chat{
  position:fixed;
  right:20px;
  bottom:20px;
  z-index:9999;
}

.support-chat__btn{
  width:56px;height:56px;border-radius:50%;
  background:linear-gradient(180deg,var(--p3),var(--p4));
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.support-chat__btn svg{fill:var(--p1);width:26px}

.support-chat__window{
  width:360px;height:520px;
  background:linear-gradient(180deg,var(--p1),rgba(5,56,107,.95));
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  position:absolute;right:0;bottom:72px;
  display:none;flex-direction:column;overflow:hidden;
}
.support-chat.open .support-chat__window{display:flex}

.support-chat__header{
  padding:12px;
  display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--border);
}
.support-chat__avatar{
  width:36px;height:36px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%,var(--p3),rgba(55,150,131,.3));
  border:1px solid rgba(142,228,175,.25);
}
.support-chat__header strong{color:var(--p5);font-size:14px}
.support-chat__header span{font-size:12px;color:var(--text-muted)}
.support-chat__close{
  margin-left:auto;cursor:pointer;
  color:var(--p5);font-size:22px;line-height:1;
  padding:6px 10px;border-radius:12px;
  border:1px solid transparent;
}
.support-chat__close:hover{border-color:var(--border);background:rgba(237,245,225,.06);}

.support-chat__messages{
  flex:1;padding:12px;overflow:auto;
  display:flex;flex-direction:column;gap:10px;
}
.support-chat__msg{
  max-width:82%;
  padding:10px 12px;
  border-radius:14px;
  font-size:14px;line-height:1.35;
  white-space:pre-wrap;word-break:break-word;
}
.support-chat__msg--bot{
  background:rgba(237,245,225,.08);
  border:1px solid var(--border);
  color:var(--p5);
}
.support-chat__msg--user{
  background:linear-gradient(180deg,var(--p2),rgba(55,150,131,.8));
  color:var(--p5);
  margin-left:auto;
}

.support-chat__quick{
  display:flex;flex-wrap:wrap;gap:8px;
  padding:10px 12px;
  border-top:1px solid var(--border);
  background:rgba(237,245,225,.03);
}
.support-chat__chip{
  border:1px solid rgba(142,228,175,.45);
  background:rgba(237,245,225,.05);
  color:var(--p5);
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
}
.support-chat__chip:hover{background:rgba(142,228,175,.14);}

.support-chat__typing span{
  display:inline-block;width:6px;height:6px;margin-right:4px;
  background:var(--p5);border-radius:50%;
  animation:supportBlink 1.2s infinite;
}
.support-chat__typing span:nth-child(2){animation-delay:.15s}
.support-chat__typing span:nth-child(3){animation-delay:.3s}
@keyframes supportBlink{0%,80%,100%{opacity:.35}40%{opacity:1}}

.support-chat__footer{
  padding:10px;
  border-top:1px solid var(--border);
  background:rgba(237,245,225,.02);
}
.support-chat__form{display:flex;gap:8px;align-items:flex-end;}
.support-chat__input{
  flex:1;resize:none;
  padding:10px;border-radius:14px;
  border:1px solid var(--border);
  background:rgba(237,245,225,.06);
  color:var(--p5);
  outline:none;
  min-height:40px;max-height:120px;
}
.support-chat__input::placeholder{color:var(--text-muted)}
.support-chat__send{
  width:44px;height:44px;
  border-radius:14px;
  border:1px solid rgba(142,228,175,.6);
  background:linear-gradient(180deg,var(--p3),var(--p4));
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.support-chat__send svg{fill:var(--p1);width:18px}

/* –º–æ–±–∏–ª–∫–∏ */
@media (max-width:420px){
  .support-chat__window{width:92vw;height:72vh;right:0;}
}
</style>

<div class="support-chat" id="supportChat">
  <button class="support-chat__btn" id="supportChatOpen" aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
    <svg viewBox="0 0 24 24">
      <path d="M4 4h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H8l-4 3v-3H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
    </svg>
  </button>

  <div class="support-chat__window" role="dialog" aria-label="–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏">
    <div class="support-chat__header">
      <div class="support-chat__avatar"></div>
      <div>
        <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</strong><br>
        <span id="supportChatStatus">–±–æ—Ç –æ–Ω–ª–∞–π–Ω</span>
      </div>
      <div class="support-chat__close" id="supportChatClose" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</div>
    </div>

    <div class="support-chat__messages" id="supportChatMessages"></div>

    <div class="support-chat__quick" id="supportChatQuick">
      <button class="support-chat__chip" type="button" data-q="–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —É—Å–ª—É–≥—É?">–£—Å–ª—É–≥–∏</button>
      <button class="support-chat__chip" type="button" data-q="–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –≤ Service Desk?">Service Desk</button>
      <button class="support-chat__chip" type="button" data-q="–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è?">–°—Ç–∞—Ç—É—Å</button>
      <button class="support-chat__chip" type="button" data-q="–ù—É–∂–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä">–û–ø–µ—Ä–∞—Ç–æ—Ä</button>
    </div>

    <div class="support-chat__footer">
      <form class="support-chat__form" id="supportChatForm">
        <textarea class="support-chat__input" id="supportChatInput" rows="1" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button class="support-chat__send" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <svg viewBox="0 0 24 24"><path d="M2 21 23 12 2 3v7l15 2-15 2z"/></svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const chat = document.getElementById('supportChat');
  const btnOpen = document.getElementById('supportChatOpen');
  const btnClose = document.getElementById('supportChatClose');
  const messagesEl = document.getElementById('supportChatMessages');
  const form = document.getElementById('supportChatForm');
  const input = document.getElementById('supportChatInput');
  const quick = document.getElementById('supportChatQuick');

  const STORAGE_KEY = 'supportChat_profile_v1';

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

  function addMessage(text, who){
    const div = document.createElement('div');
    div.className = 'support-chat__msg ' + (who === 'user' ? 'support-chat__msg--user' : 'support-chat__msg--bot');
    div.innerHTML = esc(text);
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  function addTyping(){
    const div = document.createElement('div');
    div.className = 'support-chat__msg support-chat__msg--bot support-chat__typing';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
  }

  function normalize(t){ return String(t).trim().toLowerCase(); }

  function botReply(userText){
    const t = normalize(userText);

    if (/(–ø—Ä–∏–≤–µ—Ç|hello|hi|–¥–æ–±—Ä—ã–π)/.test(t))
      return "–ü—Ä–∏–≤–µ—Ç! –Ø KissCloud Support üëã\n–í—ã–±–µ—Ä–∏ —Ç–µ–º—É –∫–Ω–æ–ø–∫–∞–º–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å.";

    if (/(—É—Å–ª—É–≥|–∫–∞—Ç–∞–ª–æ–≥|—Ç–∞—Ä–∏—Ñ|vps|vds)/.test(t))
      return "–ü–æ —É—Å–ª—É–≥–∞–º:\n‚Äî –æ—Ç–∫—Ä–æ–π —Ä–∞–∑–¥–µ–ª ¬´–£—Å–ª—É–≥–∏¬ª\n‚Äî –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é —É—Å–ª—É–≥—É\n‚Äî –æ—Ñ–æ—Ä–º–∏ –∑–∞—è–≤–∫—É/–∑–∞–∫–∞–∑\n\n–ù–∞–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ (VPS/VDS/—Ö–æ—Å—Ç–∏–Ω–≥), –∏ —è –ø–æ–¥—Å–∫–∞–∂—É.";

    if (/(service desk|–∑–∞—è–≤–∫|–æ–±—Ä–∞—â–µ–Ω|–∏–Ω—Ü–∏–¥–µ–Ω—Ç)/.test(t))
      return "Service Desk:\n1) –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª –æ–±—Ä–∞—â–µ–Ω–∏–π\n2) –ù–∞–∂–º–∏ ¬´–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É¬ª\n3) –ó–∞–ø–æ–ª–Ω–∏ —Ç–µ–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ\n\n–•–æ—á–µ—à—å —à–∞–±–ª–æ–Ω —Ç–µ–∫—Å—Ç–∞ –∑–∞—è–≤–∫–∏?";

    if (/(—Å—Ç–∞—Ç—É—Å|–≥–¥–µ|–∫–æ–≥–¥–∞|–ø—Ä–æ–≤–µ—Ä|–Ω–æ–º–µ—Ä)/.test(t))
      return "–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –Ω—É–∂–µ–Ω –Ω–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è/–∑–∞—è–≤–∫–∏.\n–ù–∞–ø–∏—à–∏: ¬´–ù–æ–º–µ—Ä: ...¬ª.";

    if (/(–æ–ø–µ—Ä–∞—Ç–æ—Ä|—á–µ–ª–æ–≤–µ–∫|–ø–æ–¥–¥–µ—Ä–∂–∫|–∞–¥–º–∏–Ω)/.test(t))
      return "–û–∫, –æ–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π + (–µ—Å–ª–∏ –µ—Å—Ç—å) –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏.\n–Ø –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–µ.";

    return "–ü–æ–Ω—è–ª. –£—Ç–æ—á–Ω–∏: —ç—Ç–æ –ø—Ä–æ ¬´–£—Å–ª—É–≥–∏¬ª, ¬´Service Desk¬ª –∏–ª–∏ ¬´–°—Ç–∞—Ç—É—Å¬ª?";
  }

  function saveHistory(){
    const history = [];
    messagesEl.querySelectorAll('.support-chat__msg').forEach(node => {
      if (node.classList.contains('support-chat__typing')) return;
      history.push({
        who: node.classList.contains('support-chat__msg--user') ? 'user' : 'bot',
        text: node.textContent
      });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const history = JSON.parse(raw);
      if(!Array.isArray(history) || history.length === 0) return false;
      history.forEach(m => addMessage(m.text, m.who));
      return true;
    }catch(e){ return false; }
  }

  function autoGrow(){
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  }

  function openChat(){ chat.classList.add('open'); setTimeout(()=>input.focus(), 50); }
  function closeChat(){ chat.classList.remove('open'); }

  btnOpen.addEventListener('click', openChat);
  btnClose.addEventListener('click', closeChat);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeChat(); });

  quick.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-q]');
    if(!btn) return;
    input.value = btn.getAttribute('data-q');
    autoGrow();
    form.requestSubmit();
  });

  input.addEventListener('input', autoGrow);
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      form.requestSubmit();
    }
  });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;

    addMessage(text, 'user');
    input.value = '';
    autoGrow();

    const typing = addTyping();
    const answer = botReply(text);

    setTimeout(()=>{
      typing.remove();
      addMessage(answer, 'bot');
      saveHistory();
    }, 350);
    saveHistory();
  });

  // init
  const had = loadHistory();
  if(!had){
    addMessage("–ü—Ä–∏–≤–µ—Ç! –Ø KissCloud Support üëã\n–ß–µ–º –ø–æ–º–æ—á—å?", "bot");
    saveHistory();
  }
})();
</script>

